<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyKiosk Client</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        *,
        *:before,
        *:after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        #body_warper {
            display: grid;
            grid-gap: 5px;
            grid-template-columns: 3fr 1fr;
            padding: 8px;
            min-height: 100vh;
        }

        #my_order {
            background: #00e1ff;
            grid-row: 1;
            max-height: 50vh;
            overflow-y: scroll;
        }

        #item_list {
            display: grid;
            grid-template-columns: repeat(4, minmax(auto, 100%));
            grid-gap: 5px;
            grid-row: 1 / span 2;
            overflow-y: scroll;
        }

        #checkout {
            background: #00ffbf;
            grid-row: 2;
        }

        .item {
            background: #0000ff;
            min-height: 50px;
            max-height: 80px;
            border-radius: 4px;
            padding: 8px;
            color: white;
            border: 1px solid #00ffbf;
            cursor: pointer;
        }

        .rst_display {
            background: #0000ff;
            min-height: 50px;
            max-height: 80px;
            border-radius: 4px;
            padding: 8px;
            color: white;
            border: 1px solid #00ffbf;
            cursor: pointer;
        }

        .cart_item {
            position: relative;
            margin: 4px;
            padding: 8px;
            background: yellow;
            border-radius: 4px;
            border: 1px solid #ffee00;

        }

        .rem {
            position: absolute;
            right: 8px;
        }

        .btn {
            border: 1px solid black;
            width: 30px;
            height: 30px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div id="body_warper">
        <div id="item_list"></div>
        <div id="my_order">My order</div>
        <div id="checkout">Chckout</div>
    </div>
    <script>
        (() => {
            const socket = io();
            let item_list = document.querySelector("#item_list");
            let items_data = []
            let selected_item = []
            let my_cart = []
            let total = 0
            socket.emit("get_item");
            socket.on("get_item", res => {
                items_data = res
                item_list.innerHTML = "";
                res.forEach(re => {
                    item_list.insertAdjacentHTML("beforeend", `<div class='item' data-id='${re.code}'>${re.code} - <span clas='item_name'>${re.name}</span> (RM ${re.price}) [${re.qty}]</div>`)
                })
            })

            click(".item", e => {
                let id = e.getAttribute("data-id")
                if (selected_item.length == 0) {
                    selected_item = items_data.find(i => i.code == id)
                }
                else {
                    selected_item = selected_item.sub_item.find(i => i.code == id)
                }
                if (selected_item.sub_item.length > 0) {
                    item_list.innerHTML = `<div class='rst_display'>Back</div>`;
                    selected_item.sub_item.forEach(si => {
                        item_list.insertAdjacentHTML("beforeend", `<div class='item' data-id='${si.code}'>${si.code} - <span clas='item_name'>${si.name}</span> (RM ${si.price}) [${si.qty}]</div>`)
                    })
                }
                else {
                    //check if item in cart
                    let in_cart = my_cart.find(i => i.code == id && i.selected == selected_item.selected)
                    if (in_cart) {
                        in_cart.cart_qty++
                    }
                    else {
                        let make_cart = selected_item
                        make_cart.cart_qty = 1
                        my_cart.push(make_cart)
                    }
                    update_cart()
                    reset_display();
                }
            })

            click(".rst_display", () => {
                reset_display()
            })

            function update_cart() {
                let my_cart_list = document.querySelector("#my_order")
                my_cart_list.innerHTML = "";
                total = 0
                my_cart.forEach(mc => {
                    my_cart_list.insertAdjacentHTML("beforeend", `<div class='cart_item' data-id='${mc.code}'><button class="btn rem">&times;</button><br><span clas='item_name'>${mc.name}</span> (RM ${mc.price} &times; ${mc.cart_qty})<br><button class='btn add'>+</button> <button class='btn sub'>-</button></div>`)
                    total += mc.price * mc.cart_qty
                })
                total = total.toFixed(2)
                let checkout = document.querySelector("#checkout")
                checkout.innerHTML = `<div>Total: RM ${total}</div>`
            }

            function reset_display() {
                selected_item = []
                item_list.innerHTML = "";
                items_data.forEach(i => {
                    item_list.insertAdjacentHTML("beforeend", `<div class='item' data-id='${i.code}'>${i.code} - <span clas='item_name'>${i.name}</span> (RM ${i.price}) [${i.qty}]</div>`)
                })
            }

            function click(selector, callback) {
                document.addEventListener("click", e => {
                    if (e.target.matches(selector)) callback(e.target)
                })
            }
        })()
    </script>
</body>

</html>